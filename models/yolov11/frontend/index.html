<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Object Detection - Full Page</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body from scrolling */
        }
        #image-container {
            position: relative;
        }
        #bbox-canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        .highlight-row {
            background-color: #e0f2fe !important;
        }
        .group:hover .tooltip {
            display: block;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        .transition-transform {
            transition: transform 0.2s ease-in-out;
        }
        /* Navigation arrow styling */
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            z-index: 10;
        }
        .nav-arrow:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        .nav-arrow:disabled {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-full">

    <div class="flex flex-col lg:flex-row h-full w-full">

        <!-- Left Column: Image and Controls -->
        <div class="w-full lg:w-3/5 flex flex-col p-6 bg-white">
            
            <!-- Controls Wrapper -->
            <div class="flex-shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <label for="image-upload" class="inline-block bg-white py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 cursor-pointer">
                            <span>Upload Image(s)</span>
                        </label>
                        <input type="file" id="image-upload" accept="image/*" class="hidden" multiple>
                        <span id="file-name" class="ml-3 text-sm text-gray-500"></span>
                    </div>
                    <div>
                        <button id="detect-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            Detect Objects
                        </button>
                    </div>
                </div>

                <div id="toolbar" class="mb-2 p-2 bg-gray-50 rounded-lg flex items-center gap-2">
                    <div class="relative group flex justify-center">
                        <button id="show-results-btn" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                        <span id="show-results-tooltip" class="tooltip absolute bottom-full mb-2 w-max hidden bg-gray-800 text-white text-xs rounded py-1 px-2">Hide Boxes</span>
                    </div>
                    <div class="relative group flex justify-center">
                        <button id="show-labels-btn" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16 4v12l-4-2-4 2V4M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </button>
                        <span id="show-labels-tooltip" class="tooltip absolute bottom-full mb-2 w-max hidden bg-gray-800 text-white text-xs rounded py-1 px-2">Hide Labels</span>
                    </div>
                    <div class="relative group flex justify-center">
                        <button id="download-btn" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </button>
                        <span id="download-tooltip" class="tooltip absolute bottom-full mb-2 w-max hidden bg-gray-800 text-white text-xs rounded py-1 px-2">Download</span>
                    </div>
                </div>
            </div>

            <!-- Image Display & Progress -->
            <div class="flex-grow relative flex flex-col justify-center items-center min-h-0 my-4">
                <div id="image-container" class="relative w-full h-full flex items-center justify-center border-2 border-dashed border-gray-300 rounded-lg bg-gray-50">
                    <img id="uploaded-image" src="" alt="Uploaded image" class="max-w-full max-h-full object-contain hidden">
                    <canvas id="bbox-canvas" class="hidden"></canvas>
                    <p id="placeholder-text" class="text-gray-500">Please select an image to get started</p>
                    
                    <!-- Navigation Arrows -->
                    <button id="prev-image-btn" class="nav-arrow left-4" disabled>&lt;</button>
                    <button id="next-image-btn" class="nav-arrow right-4" disabled>&gt;</button>

                    <!-- Image Info Icon and Popover -->
                    <div id="image-info-container" class="absolute top-2 right-2 hidden">
                        <button id="info-icon" class="p-1.5 bg-black bg-opacity-50 rounded-full hover:bg-opacity-75 focus:outline-none">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </button>
                        <div id="info-popover" class="absolute top-full right-0 mt-2 w-64 bg-white p-3 rounded-lg shadow-xl text-sm text-gray-700 hidden z-10">
                            <p class="font-semibold mb-2">Image Information</p>
                            <p><strong>File Name:</strong> <span id="info-file-name"></span></p>
                            <p><strong>File Size:</strong> <span id="info-file-size"></span></p>
                            <p><strong>Dimensions:</strong> <span id="info-dimensions"></span></p>
                            <p><strong>Type:</strong> <span id="info-type"></span></p>
                        </div>
                    </div>
                </div>
                <div id="progress-container" class="w-full mt-2 h-2 bg-gray-200 rounded-full overflow-hidden hidden">
                    <div id="progress-bar" class="bg-blue-600 h-2 rounded-full" style="width: 0%; transition: width 0.5s ease;"></div>
                </div>
            </div>

        </div>

        <!-- Right Column: Results -->
        <div id="results-column" class="w-full lg:w-2/5 flex flex-col p-6 space-y-4 bg-gray-100 border-l border-gray-200 overflow-y-auto">
            <div class="bg-white rounded-lg shadow-sm">
                <button id="toggle-summary" class="w-full flex justify-between items-center p-4">
                    <h3 class="font-bold text-lg">Summary</h3>
                    <svg class="w-5 h-5 text-gray-500 transition-transform rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div id="summary-container-content" class="p-4 pt-0 space-y-4">
                   <div id="detection-summary-section">
                       <h4 class="font-semibold text-md text-gray-800 mb-2">Detection Summary</h4>
                       <div id="detection-summary-content">
                            <p class="text-sm text-gray-600">No detections yet.</p>
                       </div>
                   </div>
                   <div id="model-summary-section">
                       <h4 class="font-semibold text-md text-gray-800 mb-2">Model Summary</h4>
                       <div id="model-summary-content">
                           <p class="text-sm text-gray-600">Run detection to see model details.</p>
                       </div>
                   </div>
                </div>
            </div>

            <div class="bg-white border rounded-lg shadow-sm flex flex-col flex-grow min-h-0">
                 <div class="p-4 flex-shrink-0 border-b">
                    <div class="flex justify-between items-center">
                         <h3 class="font-bold text-lg">Detected Objects</h3>
                         <button id="toggle-results-table" class="p-1">
                             <svg class="w-5 h-5 text-gray-500 transition-transform rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                    </div>
                     <div id="filter-container" class="mt-2">
                        <label for="class-filter" class="text-sm font-medium text-gray-700 mr-2">Filter by class:</label>
                        <select id="class-filter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"></select>
                    </div>
                 </div>
                <div id="results-table-container" class="overflow-y-auto flex-grow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">#</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const imageUpload = document.getElementById('image-upload');
        const fileNameSpan = document.getElementById('file-name');
        const uploadedImage = document.getElementById('uploaded-image');
        const imageContainer = document.getElementById('image-container');
        const bboxCanvas = document.getElementById('bbox-canvas');
        const detectButton = document.getElementById('detect-button');
        const placeholderText = document.getElementById('placeholder-text');
        const toolbar = document.getElementById('toolbar');
        const showResultsBtn = document.getElementById('show-results-btn');
        const showLabelsBtn = document.getElementById('show-labels-btn');
        const downloadBtn = document.getElementById('download-btn');
        const showResultsTooltip = document.getElementById('show-results-tooltip');
        const showLabelsTooltip = document.getElementById('show-labels-tooltip');
        const detectionSummaryContent = document.getElementById('detection-summary-content');
        const modelSummaryContent = document.getElementById('model-summary-content');
        const resultsTableBody = document.getElementById('results-table-body');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        
        // Image Info Elements
        const imageInfoContainer = document.getElementById('image-info-container');
        const infoIcon = document.getElementById('info-icon');
        const infoPopover = document.getElementById('info-popover');
        const infoFileName = document.getElementById('info-file-name');
        const infoFileSize = document.getElementById('info-file-size');
        const infoDimensions = document.getElementById('info-dimensions');
        const infoType = document.getElementById('info-type');

        // Navigation
        const prevImageBtn = document.getElementById('prev-image-btn');
        const nextImageBtn = document.getElementById('next-image-btn');

        // Collapsible section elements
        const toggleSummaryBtn = document.getElementById('toggle-summary');
        const summaryContainerContent = document.getElementById('summary-container-content');
        const toggleResultsTableBtn = document.getElementById('toggle-results-table');
        const resultsTableContainer = document.getElementById('results-table-container');
        const filterContainer = document.getElementById('filter-container');
        const classFilter = document.getElementById('class-filter');

        // --- State Management ---
        const backendUrl = 'http://localhost:8000/predict';
        let imageList = [];
        let modelInfo = null;
        let currentImageIndex = -1;
        let uiState = {
            showBoxes: true,
            showLabels: true,
            highlightedIndex: -1,
            filterClass: 'all'
        };

        // --- Event Listeners ---
        imageUpload.addEventListener('change', (event) => {
            if (event.target.files.length === 0) return;
            resetUI();
            imageList = Array.from(event.target.files).map(file => ({
                file: file,
                src: URL.createObjectURL(file),
                metadata: {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                },
                detectionResults: null
            }));
            
            if (imageList.length > 0) {
                currentImageIndex = 0;
                displayImage(currentImageIndex);
            }
            updateNavButtons();
        });

        detectButton.addEventListener('click', handleDetection);
        showResultsBtn.addEventListener('click', toggleResultsVisibility);
        showLabelsBtn.addEventListener('click', toggleLabelsVisibility);
        downloadBtn.addEventListener('click', downloadImage);
        imageContainer.addEventListener('mousemove', handleCanvasMouseMove);
        imageContainer.addEventListener('mouseleave', () => {
             if (uiState.highlightedIndex !== -1) {
                uiState.highlightedIndex = -1;
                redrawCanvas();
                clearTableHighlights();
            }
        });
        window.addEventListener('resize', () => {
            if (imageList.length > 0) redrawCanvas();
        });

        // Navigation listeners
        prevImageBtn.addEventListener('click', () => {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                displayImage(currentImageIndex);
            }
        });
        nextImageBtn.addEventListener('click', () => {
            if (currentImageIndex < imageList.length - 1) {
                currentImageIndex++;
                displayImage(currentImageIndex);
            }
        });

        // Collapsible section listeners
        toggleSummaryBtn.addEventListener('click', () => {
            const content = summaryContainerContent;
            const icon = toggleSummaryBtn.querySelector('svg');
            content.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        });

        toggleResultsTableBtn.addEventListener('click', () => {
            const icon = toggleResultsTableBtn.querySelector('svg');
            resultsTableContainer.classList.toggle('hidden');
            filterContainer.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        });

        // Image Info Popover Listener
        infoIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            infoPopover.classList.toggle('hidden');
        });
        document.addEventListener('click', (e) => {
            if (!infoPopover.classList.contains('hidden') && !infoPopover.contains(e.target) && e.target !== infoIcon) {
                infoPopover.classList.add('hidden');
            }
        });
        
        // Class filter listener
        classFilter.addEventListener('change', (e) => {
            uiState.filterClass = e.target.value;
            populateResultsTable();
            redrawCanvas();
        });


        // --- Core Functions ---
        function displayImage(index) {
            if (index < 0 || index >= imageList.length) return;
            
            const currentImage = imageList[index];
            uploadedImage.src = currentImage.src;

            uploadedImage.onload = () => {
                if (!currentImage.metadata.width) {
                    currentImage.metadata.width = uploadedImage.naturalWidth;
                    currentImage.metadata.height = uploadedImage.naturalHeight;
                }
                
                populateImageInfo();
                imageInfoContainer.classList.remove('hidden');
                uploadedImage.classList.remove('hidden');
                placeholderText.classList.add('hidden');
                imageContainer.className = 'relative w-full h-full flex items-center justify-center bg-white rounded-lg overflow-hidden';
                bboxCanvas.classList.remove('hidden');
                detectButton.disabled = false;
                
                if (currentImage.detectionResults) {
                    uiState.filterClass = 'all';
                    populateClassFilter();
                    populateResultsTable();
                    updateSummary();
                    redrawCanvas();
                } else {
                    clearResults();
                }
                // Always update model summary in case it was fetched for another image
                populateModelSummary();
                updateNavButtons();
                fileNameSpan.textContent = `${currentImage.metadata.name} (${index + 1}/${imageList.length})`;
            };
        }

        async function handleDetection() {
            if (currentImageIndex === -1) return;
            
            const currentImage = imageList[currentImageIndex];
            
            detectButton.disabled = true;
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            setTimeout(() => { progressBar.style.width = '70%'; }, 100);

            clearResults();
            
            const reader = new FileReader();
            reader.readAsDataURL(currentImage.file);
            reader.onloadend = async () => {
                const base64ImageString = reader.result.split(',')[1];
                try {
                    const response = await fetch(backendUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ base64_img: base64ImageString }),
                    });

                    if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
                    
                    const data = await response.json();
                    if (!data.bounding_boxes || !data.classes) throw new Error('Invalid response format from server.');
                    
                    currentImage.detectionResults = { boxes: data.bounding_boxes, classes: data.classes };
                    if (data.model_info) {
                        modelInfo = data.model_info;
                    }
                    
                    uiState.showBoxes = true;
                    uiState.showLabels = true;
                    uiState.filterClass = 'all';
                    populateClassFilter();
                    populateResultsTable();
                    updateSummary();
                    populateModelSummary();
                    redrawCanvas();

                } catch (error) {
                    console.error('Error during object detection:', error);
                } finally {
                    progressBar.style.width = '100%';
                    setTimeout(() => {
                        progressContainer.classList.add('hidden');
                        detectButton.disabled = false;
                    }, 500);
                }
            };
        }

        function redrawCanvas() {
            if (currentImageIndex === -1 || !uploadedImage.complete || uploadedImage.naturalWidth === 0) return;
            
            const currentImage = imageList[currentImageIndex];
            const detectionResults = currentImage.detectionResults;
            
            const ctx = bboxCanvas.getContext('2d');
            
            bboxCanvas.width = uploadedImage.clientWidth;
            bboxCanvas.height = uploadedImage.clientHeight;
            ctx.clearRect(0, 0, bboxCanvas.width, bboxCanvas.height);

            if (!uiState.showBoxes || !detectionResults || detectionResults.boxes.length === 0) return;

            const scaleX = bboxCanvas.clientWidth / uploadedImage.naturalWidth;
            const scaleY = bboxCanvas.clientHeight / uploadedImage.naturalHeight;
            const colors = ['#FF3838', '#FF9D42', '#42A5F5', '#66BB6A', '#AB47BC', '#FFD700', '#00FFFF'];

            detectionResults.boxes.forEach((box, i) => {
                const className = detectionResults.classes[i];
                if (uiState.filterClass !== 'all' && className !== uiState.filterClass) return;

                const isHighlighted = (i === uiState.highlightedIndex);
                const color = colors[i % colors.length];
                ctx.strokeStyle = color;
                ctx.lineWidth = isHighlighted ? 5 : 3;
                const x = box.left * scaleX;
                const y = box.top * scaleY;
                const width = (box.right - box.left) * scaleX;
                const height = (box.bottom - box.top) * scaleY;
                ctx.strokeRect(x, y, width, height);

                if (uiState.showLabels) {
                    const label = className || 'unknown';
                    ctx.fillStyle = color;
                    ctx.font = 'bold 16px Inter';
                    const textWidth = ctx.measureText(label).width;
                    ctx.fillRect(x, y - 20, textWidth + 8, 20);
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillText(label, x + 4, y - 5);
                }
            });
        }

        // --- UI Update Functions ---
        function populateImageInfo() {
            const metadata = imageList[currentImageIndex].metadata;
            infoFileName.textContent = metadata.name;
            infoFileSize.textContent = `${(metadata.size / 1024).toFixed(2)} KB`;
            infoDimensions.textContent = `${metadata.width} x ${metadata.height} px`;
            infoType.textContent = metadata.type;
        }
        
        function populateClassFilter() {
            const detectionResults = imageList[currentImageIndex]?.detectionResults;
            classFilter.innerHTML = '<option value="all">All Classes</option>';
            if (!detectionResults) return;
            
            const uniqueClasses = [...new Set(detectionResults.classes)];
            uniqueClasses.sort().forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classFilter.appendChild(option);
            });
        }

        function populateResultsTable() {
            const detectionResults = imageList[currentImageIndex]?.detectionResults;
            resultsTableBody.innerHTML = '';
            if (!detectionResults) return;

            let displayIndex = 1;
            detectionResults.classes.forEach((className, i) => {
                if (uiState.filterClass !== 'all' && className !== uiState.filterClass) return;
                
                const row = document.createElement('tr');
                row.className = 'cursor-pointer hover:bg-gray-50';
                row.dataset.index = i;
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${displayIndex++}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${className}</td>
                `;
                row.addEventListener('mouseenter', () => handleTableRowHover(i, true));
                row.addEventListener('mouseleave', () => handleTableRowHover(i, false));
                resultsTableBody.appendChild(row);
            });
        }

        function updateSummary() {
            const detectionResults = imageList[currentImageIndex]?.detectionResults;
            if (!detectionResults || detectionResults.classes.length === 0) {
                detectionSummaryContent.innerHTML = `<p class="text-sm text-gray-600">No objects detected.</p>`;
                return;
            }
            const total = detectionResults.classes.length;
            const classCounts = detectionResults.classes.reduce((acc, val) => {
                acc[val] = (acc[val] || 0) + 1;
                return acc;
            }, {});

            let summaryHTML = `<p><strong>Total Objects:</strong> ${total}</p><ul class="list-disc list-inside mt-2 text-sm">`;
            for (const [className, count] of Object.entries(classCounts).sort()) {
                summaryHTML += `<li>${className}: ${count}</li>`;
            }
            summaryHTML += `</ul>`;
            detectionSummaryContent.innerHTML = summaryHTML;
        }

        function populateModelSummary() {
            if (!modelInfo) {
                modelSummaryContent.innerHTML = `<p class="text-sm text-gray-600">Run detection to see model details.</p>`;
                return;
            }
            const labelsHtml = modelInfo.labels.map(label => `<span class="inline-block bg-gray-200 rounded-full px-2 py-1 text-xs font-semibold text-gray-700 mr-2 mb-2">${label}</span>`).join('');
            modelSummaryContent.innerHTML = `
                <div class="space-y-2 text-sm">
                    <p><strong>Parameters:</strong> ${modelInfo.parameters.toLocaleString()}</p>
                    <p><strong>Layers:</strong> ${modelInfo.layers.toLocaleString()}</p>
                    <div>
                        <p class="font-semibold">Labels (${modelInfo.labels.length}):</p>
                        <div class="mt-1 max-h-24 overflow-y-auto p-2 bg-gray-50 rounded-md border">
                            ${labelsHtml}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function updateNavButtons() {
            prevImageBtn.disabled = currentImageIndex <= 0;
            nextImageBtn.disabled = currentImageIndex >= imageList.length - 1;
        }

        function clearResults() {
            resultsTableBody.innerHTML = '';
            detectionSummaryContent.innerHTML = '<p class="text-sm text-gray-600">No detections yet.</p>';
            classFilter.innerHTML = '<option value="all">All Classes</option>';
            uiState.highlightedIndex = -1;
            clearCanvas();
        }

        function resetUI() {
            imageList.forEach(img => URL.revokeObjectURL(img.src));
            imageList = [];
            modelInfo = null;
            currentImageIndex = -1;
            uiState.filterClass = 'all';
            clearResults();
            populateModelSummary();
            imageContainer.className = 'relative w-full h-full flex items-center justify-center border-2 border-dashed border-gray-300 rounded-lg bg-gray-50';
            uploadedImage.src = '';
            uploadedImage.classList.add('hidden');
            placeholderText.classList.remove('hidden');
            bboxCanvas.classList.add('hidden');
            imageInfoContainer.classList.add('hidden');
            infoPopover.classList.add('hidden');
            detectButton.disabled = true;
            fileNameSpan.textContent = '';
            updateNavButtons();
        }

        // --- Interactivity Handlers ---
        function handleTableRowHover(index, isHovering) {
            uiState.highlightedIndex = isHovering ? index : -1;
            redrawCanvas();
        }
        
        function handleCanvasMouseMove(event) {
            if (!uiState.showBoxes || currentImageIndex === -1) return;
            const detectionResults = imageList[currentImageIndex].detectionResults;
            if (!detectionResults) return;

            const canvasRect = bboxCanvas.getBoundingClientRect();
            const scaleX = bboxCanvas.width / uploadedImage.naturalWidth;
            const scaleY = bboxCanvas.height / uploadedImage.naturalHeight;
            const mouseX = event.clientX - canvasRect.left;
            const mouseY = event.clientY - canvasRect.top;

            let foundIndex = -1;
            for (let i = detectionResults.boxes.length - 1; i >= 0; i--) {
                const className = detectionResults.classes[i];
                if (uiState.filterClass !== 'all' && className !== uiState.filterClass) continue;
                
                const box = detectionResults.boxes[i];
                const x = box.left * scaleX;
                const y = box.top * scaleY;
                const width = (box.right - box.left) * scaleX;
                const height = (box.bottom - box.top) * scaleY;

                if (mouseX >= x && mouseX <= x + width && mouseY >= y && mouseY <= y + height) {
                    foundIndex = i;
                    break;
                }
            }
            
            if (foundIndex !== uiState.highlightedIndex) {
                uiState.highlightedIndex = foundIndex;
                redrawCanvas();
                highlightTableRow(foundIndex);
            }
        }
        
        function highlightTableRow(index) {
            clearTableHighlights();
            if (index !== -1) {
                const row = resultsTableBody.querySelector(`[data-index='${index}']`);
                if(row) row.classList.add('highlight-row');
            }
        }

        function clearTableHighlights() {
            document.querySelectorAll('#results-table-body tr').forEach(r => r.classList.remove('highlight-row'));
        }
        
        function clearCanvas() {
            const ctx = bboxCanvas.getContext('2d');
            ctx.clearRect(0, 0, bboxCanvas.width, bboxCanvas.height);
        }

        // --- Toolbar Actions ---
        function toggleResultsVisibility() {
            uiState.showBoxes = !uiState.showBoxes;
            showResultsTooltip.textContent = uiState.showBoxes ? 'Hide Boxes' : 'Show Boxes';
            redrawCanvas();
        }

        function toggleLabelsVisibility() {
            uiState.showLabels = !uiState.showLabels;
            showLabelsTooltip.textContent = uiState.showLabels ? 'Hide Labels' : 'Show Labels';
            redrawCanvas();
        }

        function downloadImage() {
            if (currentImageIndex === -1) return;
            const currentImage = imageList[currentImageIndex];
            const detectionResults = currentImage.detectionResults;

            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = uploadedImage.naturalWidth;
            tempCanvas.height = uploadedImage.naturalHeight;
            tempCtx.drawImage(uploadedImage, 0, 0);

            if (uiState.showBoxes && detectionResults) {
                const colors = ['#FF3838', '#FF9D42', '#42A5F5', '#66BB6A', '#AB47BC', '#FFD700', '#00FFFF'];
                detectionResults.boxes.forEach((box, i) => {
                    const color = colors[i % colors.length];
                    tempCtx.strokeStyle = color;
                    tempCtx.lineWidth = 5;
                    const x = box.left;
                    const y = box.top;
                    const width = box.right - box.left;
                    const height = box.bottom - box.top;
                    tempCtx.strokeRect(x, y, width, height);
                    
                    if (uiState.showLabels) {
                        const className = detectionResults.classes[i] || 'unknown';
                        tempCtx.fillStyle = color;
                        tempCtx.font = 'bold 24px Inter';
                        const textWidth = tempCtx.measureText(className).width;
                        tempCtx.fillRect(x, y - 30, textWidth + 10, 30);
                        tempCtx.fillStyle = '#FFFFFF';
                        tempCtx.fillText(className, x + 5, y - 5);
                    }
                });
            }

            const link = document.createElement('a');
            link.download = `detection-${currentImage.metadata.name}`;
            link.href = tempCanvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>
</html>
